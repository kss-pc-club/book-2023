# 茨城県教育情報ネットワークの脆弱性を報告した話

<span class="author">eno1220</span>

本記事は、茨城県教育情報ネットワークが認知していない未修正の脆弱性を公開することを意図したものではありません。
また、茨城県教育情報ネットワークを構成する各 web サイトなどで脆弱性を発見した場合は、報告をするようにしてください。

## はじめに

こんにちは。2022-23 年度パソコン部副部長の eno1220 です。普段は競プロや web 開発を行っています。
さて、この記事では 2022 年 12 月に私と卒業生である Ryoga.exe が発見した、茨城県教育情報ネットワークの脆弱性について紹介を行います。

## 茨城県教育情報ネットワークについて

自分で説明するのは面倒なので、公式の説明<span class="footnote">https://kyoiku.pref.ibaraki.jp/education-policy/page-10899</span>を引用します。

> 茨城県教育情報ネットワークは、統一したセキュリティ対策のもとで県立学校とその他の教育機関を光ファイバー回線で結び、より高度な「教育の情報化」の実現を目指して構築されたネットワークシステムです。教職員向けポータルサイトは、県内の小学校・中学校・義務教育学校・高等学校・中等教育学校・特別支援学校とすべての教職員約 26,000 人の情報共有基盤として、学習支援や校務の効率化など様々な活用が進んでいます。

調べたところによれば、平成 17 年ごろから（つまり現在 6 年次生である私が生まれた頃から）運用を開始しているようで、全国的に見ても早い段階から「教育の情報化」の実現を目指していたことが推察されます。

教育情報ネットワークは 2022 年 8 月にリニューアルが実施され、それまで運用されていたシステムと比べて さまざまな機能<span class="footnote">公開されている範囲で言えば、「教材データベース」が一般の方でも閲覧できるようになりました。</span>が追加されました。また、このリニューアルでポータルサイトが刷新され、フロントエンドが`Vue.js`で記述されるなどモダンな技術で構成されるようになりました。

ポータルサイトには、私たち生徒や教員がアクセスすることができ、資料の共有<span class="footnote">主に異なる学校間や教育委員会から県内全体に発信されるような資料の共有を行なっている。</span>や教材の閲覧を行うことができるほか、教員に関しては公文書の共有、お知らせの発信などを行うことができます。

## 脆弱性の発見までの経過

- 2022 年 12 月 6 日深夜に、eno1220 がポータルサイトの設計やコードを見るためにブラウ aaa ザの Developer tool で遊んでいた
- この中で、セッションストレージ<span class="footnote">ブラウザのデータを保存しておく領域の一つ</span>にログイン時に API サーバから fetch してきたユーザ情報<span class="footnote">ユーザ名、個人 ID、学校 ID、ポータルサイトの設定など</span>が保存されていることに気づいた
- 翌日 12 月 7 日の部活中に前日に気づいたことをもとに Ryoga.exe とポータルサイトを調べていたところ、脆弱性を発見した

## 脆弱性の概要

セッションストレージに保存されているユーザ情報を書き換えることで、ポータルサイトの特定ページにおいてシステム管理者モードへと権限を不正に昇格することができる。これにより、本来閲覧することのできないコンテンツが閲覧できる状態となった。

## 脆弱性の詳細

ポータルサイトは前述の通り、フロントエンドは`Vue.js`で記述されており、API サーバとやり取りをする形で動作しています。
ポータルサイトにログインするには、茨城県教育委員会から各生徒や教職員に提供されている Google アカウントが必要であり、これを用いて SAML 認証を行なっているように見えます。<span class="footnote">Google Cloud Platform の提供する機能を用いてうまく構築していると考えられる。</span>（筆者は認証・認可に詳しくないため詳細は省略する。）

Developer tool の「ネットワーク」タブから通信の様子を監視していると、ログイン後に API サーバを叩いてユーザ情報を取得し、セッションストレージに保存していることがわかりました。セッションストレージに保存されている情報には、ユーザ名やユーザ ID、組織（学校）の ID などが含まれていました。

さて、調べを進めていくと、この中に`accountDivision`という項目があることに気づきました。値が`b1`になっていることと合わせて考えてみると、これはユーザの分類を表しているであろうことが推測されます。この値を適当に書き換えていたところ、画面上に「モード切替」ボタンが出現し、「システム管理者モード」へとモードが切り替わることを発見しました。

ポータルシステムのトップページには`「お知らせ」を表示する欄`があり、生徒が閲覧した場合においては何も表示されないようになっています。ところが、「モード切替」ボタンを押し、「システム管理者モード」へとモードを切り替えると、`「お知らせ」を表示する欄`に投稿された「お知らせ」のリストが表示されてしまいました。

なお、上記以外で「システム管理者モード」へとモードが切り替わることで本来とは異なる挙動をするページはありませんでした。（上記以外の脆弱性は発見できませんでした。）

## その後の経過

本来の挙動とは異なる表示がなされたと判断し、すぐに管理者に報告を行いました。

- 2022/12/7 17:30 脆弱性を発見
- 2022/12/8 09:30 脆弱性の詳細を報告
- 2022/12/8 15:30 脆弱性の再現の確認と開発元への通知完了の報告を受ける
- 2022/12/26 15:00 脆弱性修正の完了の報告を受ける

修正完了の報告を受けるまでに期間が少し空いていますが、どうやら報告を受けたかなり前には修正が完了していたようです。（12 月 20 日ごろに学校を経由して連絡をいただいた際に、学校側で不手際があったらしい）

## おわりに

脆弱性の報告をして、なにか責められるのではないか...?とも思っていましたが、そのようなことはなく、迅速に対応いただきました。対応いただいた管理者の方々、開発者の方々に感謝いたします。

ところで、これを機に CTF とかやってみるか〜と思ったまま半年くらいなにもやっていません...大学に行ったらやってみたいですね。
